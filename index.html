<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Basura en Biob铆o</title>

  <!-- Mapbox & Bootstrap -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Estilos -->
  <link href="flujos.css" rel="stylesheet">
  <link href="story.css" rel="stylesheet">
</head>

<body>

<!--  Toggle de Modos -->
<button id="mode-toggle" class="mode-toggle-btn" title="Cambiar modo">
  <span class="mode-icon explore-icon">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="M21 21l-4.35-4.35"></path>
    </svg>
  </span>
  <span class="mode-icon story-icon" style="display:none;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
    </svg>
  </span>
  <span class="mode-text">Historia</span>
</button>

<div class="container-fluid">
  <div class="row">

    <!--  Panel Lateral (Solo modo exploraci贸n) -->
    <div id="explore-panel" class="col-md-3 bg-dark text-white vh-100 p-3 overflow-auto">

      <!-- Section 1: Branding -->
      <div class="text-center mb-4">
        <img src="./assets/citylab-logo.png" alt="City Lab Biob铆o" class="img-fluid mb-2" style="max-width: 150px;">
        <p class="small" style="text-align: left;">
          <br>
          Visualizaci贸n interactiva de flujos de residuos entre comunas y rellenos sanitarios.
        </p>
      </div>

      <!-- Section 2: Filters -->
      <div class="mb-4">
        <h6 class="fw-bold text-uppercase">Filtros de Visualizaci贸n</h6>

        <label class="form-label">Rellenos sanitarios</label>
        <div class="d-grid gap-2">
          <div class="form-check form-switch text-light">
            <input class="form-check-input" type="checkbox" value="Relleno Cemarc Penco">
            <label class="form-check-label">Cemarc Penco</label>
          </div>
          <div class="form-check form-switch text-light">
            <input class="form-check-input" type="checkbox" value="Relleno Los ngeles">
            <label class="form-check-label">Los ngeles</label>
          </div>
          <div class="form-check form-switch text-light">
            <input class="form-check-input" type="checkbox" value="Relleno Fundo Las Cruces">
            <label class="form-check-label">Fundo Las Cruces</label>
          </div>
          <div class="form-check form-switch text-light">
            <input class="form-check-input" type="checkbox" value="Vertedero Licura">
            <label class="form-check-label">Licura</label>
          </div>
          <div class="form-check form-switch text-light">
            <input class="form-check-input" type="checkbox" value="Relleno Sanitario Arauco Curanilahue">
            <label class="form-check-label">Arauco Curanilahue</label>
          </div>
        </div>

        <label class="form-label mt-3">Comunas asociadas</label>
        <div id="comunaList" class="comuna-tag-container"></div>

      </div>

      <!-- Section 3: Info + Chart -->
      <div>
        <h6 class="fw-bold text-uppercase">Informaci贸n</h6>
        <p id="comunaSummaryText" class="small">
          Visualizando comunas que env铆an residuos a <span id="rellenoNameText">[relleno]</span>.
        </p>

        <div class="mb-2">
          <strong>Total toneladas:</strong>
          <div class="fs-4 text-info" id="toneladasCounter">0</div>
        </div>
      </div>
    </div>

    <!--  Contenedor del Mapa -->
    <div id="map-container" class="col-md-9 p-0 position-relative" style="z-index: 0;">
      <div class="position-absolute top-0 start-0 w-100 h-100">
        <div id="map" class="w-100 h-100" style="z-index: 0;"></div>
        <canvas id="flow" class="position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none; z-index: 1;"></canvas>
        <div id="label-container" class="position-absolute top-0 start-0 w-100 h-100" style="z-index: 2;"></div>
      </div>
    </div>
  </div>
</div>

<!--  Scripts -->
<script type="module">
  import { visualizationAPI } from './main.js';
  import { initStory } from './story.js';

  //  Detectar modo desde URL
  const urlParams = new URLSearchParams(window.location.search);
  let currentMode = urlParams.get('mode') || 'explore';

  //  Aplicar modo inicial
  function applyMode(mode) {
    const explorePanel = document.getElementById('explore-panel');
    const mapContainer = document.getElementById('map-container');
    const modeToggleBtn = document.getElementById('mode-toggle');
    const modeText = modeToggleBtn.querySelector('.mode-text');
    const exploreIcon = modeToggleBtn.querySelector('.explore-icon');
    const storyIcon = modeToggleBtn.querySelector('.story-icon');

    if (mode === 'story') {
      // Modo Story
      document.body.classList.add('story-mode');
      document.body.classList.remove('explore-mode');
      explorePanel.style.display = 'none';
      mapContainer.classList.remove('col-md-9');
      mapContainer.classList.add('col-12');
      modeText.textContent = 'Explorar';
      exploreIcon.style.display = 'block';
      storyIcon.style.display = 'none';

      // Iniciar storytelling
      initStory();

    } else {
      // Modo Explore
      document.body.classList.add('explore-mode');
      document.body.classList.remove('story-mode');
      explorePanel.style.display = 'block';
      mapContainer.classList.remove('col-12');
      mapContainer.classList.add('col-md-9');
      modeText.textContent = 'Historia';
      exploreIcon.style.display = 'none';
      storyIcon.style.display = 'block';
    }

    currentMode = mode;
  }

  //  Toggle entre modos
  document.getElementById('mode-toggle').addEventListener('click', () => {
    const newMode = currentMode === 'explore' ? 'story' : 'explore';

    // Actualizar URL sin recargar
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('mode', newMode);
    window.history.pushState({}, '', newUrl);

    // Recargar p谩gina para cambiar modo limpiamente
    window.location.reload();
  });

  // Aplicar modo inicial
  applyMode(currentMode);
</script>

<script type="module" src="main.js"></script>
<script type="module" src="panel.js"></script>

</body>
</html>